# ğŸ’¬ WebSocket èŠå¤©å®¤

åŸºäº C++23 åç¨‹çš„å®æ—¶å¤šç”¨æˆ·èŠå¤©å®¤ï¼Œæ”¯æŒç”¨æˆ·æ˜µç§°ã€åœ¨çº¿åˆ—è¡¨ã€æ¶ˆæ¯å¹¿æ’­ç­‰åŠŸèƒ½ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ‘¥ **å¤šç”¨æˆ·èŠå¤©**ï¼šæ”¯æŒå¤šä¸ªç”¨æˆ·åŒæ—¶åœ¨çº¿
- ğŸ“ **è‡ªå®šä¹‰æ˜µç§°**ï¼šç”¨æˆ·å¯ä»¥è®¾ç½®è‡ªå·±çš„æ˜µç§°
- ğŸ“Š **åœ¨çº¿ç”¨æˆ·åˆ—è¡¨**ï¼šå®æ—¶æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- ğŸ”” **åŠ å…¥/ç¦»å¼€é€šçŸ¥**ï¼šç”¨æˆ·è¿›å‡ºèŠå¤©å®¤æ—¶è‡ªåŠ¨é€šçŸ¥
- ğŸ’¬ **å®æ—¶æ¶ˆæ¯**ï¼šæ¶ˆæ¯å³æ—¶å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·
- ğŸ¨ **æ¼‚äº®çš„ UI**ï¼šç°ä»£åŒ–çš„èŠå¤©ç•Œé¢

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘æœåŠ¡å™¨

```bash
cd build
cmake ..
ninja websocket_server
```

### 2. å¯åŠ¨æœåŠ¡å™¨

```bash
./websocket_server

# è¾“å‡º:
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ’¬ WebSocket Chat Room (C++23)         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ Server listening on ws://localhost:8080
ğŸ“ HTTP UI: http://localhost:8080
Press Ctrl+C to stop
```

### 3. æ‰“å¼€èŠå¤©å®¤

**æ–¹æ³• 1ï¼šä½¿ç”¨æµè§ˆå™¨ï¼ˆæ¨èï¼‰**

ç”¨æµè§ˆå™¨æ‰“å¼€ `examples/chatroom.html`ï¼Œæˆ–è€…ç›´æ¥è®¿é—® `http://localhost:8080`

**æ–¹æ³• 2ï¼šå¤šä¸ªæµè§ˆå™¨çª—å£æµ‹è¯•**

1. æ‰“å¼€ç¬¬ä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œè¾“å…¥æ˜µç§° "Alice"
2. æ‰“å¼€ç¬¬äºŒä¸ªæµè§ˆå™¨çª—å£ï¼Œè¾“å…¥æ˜µç§° "Bob"
3. å¼€å§‹èŠå¤©ï¼

## ğŸ“¸ ç•Œé¢å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidebar        â”‚  Chat Area                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ’¬ Chat   â”‚  â”‚  â”‚ ğŸš€ Welcome to Chat Room â”‚ â”‚
â”‚  â”‚ Room      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚           â”‚  â”‚                               â”‚
â”‚  â”‚ â— Connectedâ”‚ â”‚  [Messages Area]             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  Alice: Hello!               â”‚
â”‚  â”‚ ğŸ‘¤ Alice  â”‚  â”‚  Bob: Hi there!              â”‚
â”‚  â”‚ ğŸ‘¤ Bob    â”‚  â”‚  System: Charlie joined      â”‚
â”‚  â”‚ ğŸ‘¤ Charlieâ”‚  â”‚                               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  [Input]                     â”‚
â”‚  â”‚ 3 users   â”‚  â”‚  Type message... [Send]      â”‚
â”‚  â”‚ online    â”‚  â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ åè®®è¯´æ˜

### æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ **JSON** æ ¼å¼ï¼š

#### 1. ç³»ç»Ÿæ¶ˆæ¯
```json
{
    "type": "system",
    "message": "Welcome to Chat Room!"
}
```

#### 2. æ™®é€šèŠå¤©æ¶ˆæ¯
```json
{
    "type": "message",
    "user": "Alice",
    "message": "Hello everyone!"
}
```

#### 3. ç”¨æˆ·åŠ å…¥
```json
{
    "type": "join",
    "user": "Bob"
}
```

#### 4. ç”¨æˆ·ç¦»å¼€
```json
{
    "type": "leave",
    "user": "Charlie"
}
```

#### 5. ç”¨æˆ·åˆ—è¡¨æ›´æ–°
```json
{
    "type": "userlist",
    "users": ["Alice", "Bob", "Charlie"]
}
```

## ğŸ® ä½¿ç”¨æµç¨‹

### å®¢æˆ·ç«¯è¿æ¥æµç¨‹

```
1. è¿æ¥ WebSocket
   ws://localhost:8080
   
2. æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯
   {"type":"system","message":"Welcome..."}
   
3. å‘é€æ˜µç§°
   â†’ "Alice"
   
4. æ”¶åˆ°ç¡®è®¤
   â† {"type":"system","message":"Welcome, Alice!"}
   
5. æ”¶åˆ°ç”¨æˆ·åˆ—è¡¨
   â† {"type":"userlist","users":["Alice"]}
   
6. å‘é€èŠå¤©æ¶ˆæ¯
   â†’ "Hello everyone!"
   
7. æ‰€æœ‰äººæ”¶åˆ°æ¶ˆæ¯
   â† {"type":"message","user":"Alice","message":"Hello everyone!"}
```

## ğŸ“Š æœåŠ¡å™¨æ—¥å¿—

```bash
[ACCEPT] New connection - FD: 4
[CHAT] User registered: Alice (FD: 4)
[CHAT] Alice: Hello everyone!
[ACCEPT] New connection - FD: 5
[CHAT] User registered: Bob (FD: 5)
[CHAT] Bob: Hi Alice!
[CHAT] Alice left the chat
```

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### å¹¶å‘æ¨¡å‹

```
æ¯ä¸ªç”¨æˆ· â†’ ç‹¬ç«‹åç¨‹ (task<void>)
           â†“
    åç¨‹è°ƒåº¦å™¨ (executor)
           â†“
    çº¿ç¨‹æ±  (4 workers)
           â†“
    å¼‚æ­¥ I/O (async_read/write)
```

### æ•°æ®ç»“æ„

```cpp
struct ChatUser {
    int fd;                      // Socket æ–‡ä»¶æè¿°ç¬¦
    std::string nickname;        // ç”¨æˆ·æ˜µç§°
    std::chrono::time_point join_time;  // åŠ å…¥æ—¶é—´
};

std::vector<ChatUser> chat_users;  // æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
std::mutex users_mutex;            // çº¿ç¨‹å®‰å…¨é”
```

### å…³é”®å‡½æ•°

```cpp
// å¤„ç† WebSocket å®¢æˆ·ç«¯
task<void> handle_websocket_client(int client_fd);

// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·
task<void> broadcast_message(const std::string& message, int exclude_fd = -1);

// å¹¿æ’­ç”¨æˆ·åˆ—è¡¨æ›´æ–°
task<void> broadcast_user_list();
```

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šåŸºæœ¬èŠå¤©

1. Alice åŠ å…¥èŠå¤©å®¤
2. Bob åŠ å…¥èŠå¤©å®¤
3. Alice å‘é€: "Hello Bob!"
4. Bob æ”¶åˆ°æ¶ˆæ¯å¹¶å›å¤: "Hi Alice!"
5. åŒæ–¹éƒ½èƒ½çœ‹åˆ°å¯¹æ–¹çš„æ¶ˆæ¯

### åœºæ™¯ 2ï¼šå¤šäººèŠå¤©

1. æ‰“å¼€ 3 ä¸ªæµè§ˆå™¨çª—å£
2. åˆ†åˆ«ä»¥ Aliceã€Bobã€Charlie çš„èº«ä»½åŠ å…¥
3. ä»»ä½•äººå‘é€çš„æ¶ˆæ¯ï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°
4. ä¾§è¾¹æ æ˜¾ç¤º 3 ä¸ªåœ¨çº¿ç”¨æˆ·

### åœºæ™¯ 3ï¼šç”¨æˆ·è¿›å‡º

1. Alice å·²åœ¨çº¿
2. Bob åŠ å…¥ â†’ Alice æ”¶åˆ° "Bob joined the chat"
3. Charlie åŠ å…¥ â†’ Alice å’Œ Bob éƒ½æ”¶åˆ°é€šçŸ¥
4. Bob ç¦»å¼€ â†’ Alice å’Œ Charlie æ”¶åˆ° "Bob left the chat"

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æµè§ˆå™¨å¼€å‘è€…å·¥å…·

æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°ï¼ŒæŸ¥çœ‹ WebSocket æ¶ˆæ¯ï¼š

```javascript
// æŸ¥çœ‹æ‰€æœ‰ WebSocket æ¶ˆæ¯
// Network â†’ WS â†’ Messages
```

### 2. å‘½ä»¤è¡Œæµ‹è¯•

ä½¿ç”¨ `websocat` æµ‹è¯•ï¼š

```bash
# ç»ˆç«¯ 1
./websocket_server

# ç»ˆç«¯ 2
websocat ws://localhost:8080
> Alice                    # è¾“å…¥æ˜µç§°
< {"type":"system","message":"Welcome, Alice!"}
> Hello from terminal!     # å‘é€æ¶ˆæ¯
```

### 3. å¤šå®¢æˆ·ç«¯æµ‹è¯•

```bash
# åŒæ—¶å¯åŠ¨å¤šä¸ª websocat
websocat ws://localhost:8080 &
websocat ws://localhost:8080 &
websocat ws://localhost:8080 &
```

## ğŸš€ æ€§èƒ½ç‰¹ç‚¹

- **å¼‚æ­¥éé˜»å¡**ï¼šæ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- **åç¨‹é©±åŠ¨**ï¼šæ¯ä¸ªç”¨æˆ·ä¸€ä¸ªè½»é‡çº§åç¨‹
- **ä½å»¶è¿Ÿ**ï¼šæ¶ˆæ¯å¹¿æ’­å‡ ä¹å®æ—¶
- **é«˜å¹¶å‘**ï¼šç†è®ºæ”¯æŒä¸Šåƒå¹¶å‘è¿æ¥

## ğŸ’¡ æ‰©å±•æƒ³æ³•

### åŠŸèƒ½æ‰©å±•

1. **ç§èŠåŠŸèƒ½**
   ```json
   {"type":"private","to":"Bob","message":"Secret!"}
   ```

2. **èŠå¤©å®¤æˆ¿é—´**
   ```json
   {"type":"join_room","room":"general"}
   ```

3. **æ¶ˆæ¯å†å²**
   - ä¿å­˜æœ€è¿‘ 100 æ¡æ¶ˆæ¯
   - æ–°ç”¨æˆ·åŠ å…¥æ—¶å‘é€å†å²è®°å½•

4. **è¡¨æƒ…æ”¯æŒ**
   ```
   :smile: â†’ ğŸ˜Š
   :heart: â†’ â¤ï¸
   ```

5. **æ–‡ä»¶åˆ†äº«**
   - Base64 ç¼–ç å°æ–‡ä»¶
   - æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½é“¾æ¥

6. **åœ¨çº¿çŠ¶æ€**
   ```json
   {"type":"status","user":"Alice","status":"typing"}
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **æ¶ˆæ¯é˜Ÿåˆ—**
   - æ‰¹é‡å‘é€æ¶ˆæ¯
   - å‡å°‘ç³»ç»Ÿè°ƒç”¨

2. **è¿æ¥æ± **
   - å¤ç”¨ WebSocket è¿æ¥
   - å‡å°‘æ¡æ‰‹å¼€é”€

3. **å‹ç¼©**
   - WebSocket permessage-deflate
   - å‡å°‘å¸¦å®½ä½¿ç”¨

## ğŸ“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆç”¨æˆ·åˆ—è¡¨æ²¡æ›´æ–°ï¼Ÿ
A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼Œç¡®ä¿æ”¶åˆ° `userlist` æ¶ˆæ¯ã€‚

### Q: æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ
A: ç¡®ä¿ WebSocket å·²è¿æ¥ï¼ˆçŠ¶æ€æ˜¾ç¤º "â— Connected"ï¼‰ã€‚

### Q: æ”¯æŒå¤šå°‘ç”¨æˆ·ï¼Ÿ
A: ç†è®ºä¸Šæ”¯æŒä¸Šåƒç”¨æˆ·ï¼Œå®é™…å–å†³äºæœåŠ¡å™¨æ€§èƒ½ã€‚

### Q: æ¶ˆæ¯æœ‰å»¶è¿Ÿå—ï¼Ÿ
A: å‡ ä¹æ²¡æœ‰å»¶è¿Ÿï¼Œæ¶ˆæ¯é€šè¿‡åç¨‹ç«‹å³å¹¿æ’­ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [WebSocket Protocol RFC 6455](https://tools.ietf.org/html/rfc6455)
- [C++20 Coroutines](https://en.cppreference.com/w/cpp/language/coroutines)
- [JSON Format](https://www.json.org/)

## ğŸ‰ å¼€å§‹èŠå¤©å§ï¼

å¯åŠ¨æœåŠ¡å™¨ï¼Œæ‰“å¼€ `chatroom.html`ï¼Œé‚€è¯·æœ‹å‹ä¸€èµ·èŠå¤©ï¼

```bash
./websocket_server
# ç„¶åæ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:8080
```

Have fun! ğŸ’¬ğŸš€
